---
title: "simulate the tamia experiment"
author: "Andrew and Catherine"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: tactile
    highlight: github
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}

library(tidyverse)
library(tidybayes)
library(brms)

known_M_fid <- 500
known_prop_habituate <- .7
known_obs_demi <- 2

curve(known_M_fid * (1 - known_prop_habituate*x/(known_obs_demi + x)),
      xlim = c(0, 35),
      ylim = c(0, 1000))

disp <- 50

nobs <- 15

fake_tamia <- tibble(num_obs = 1:nobs,
       reponse_moy = known_M_fid * (1 - known_prop_habituate*num_obs/(known_obs_demi + num_obs)),
       FID = rgamma(nobs, reponse_moy^2/disp^2, reponse_moy/disp^2))

fake_tamia |>
  ggplot(aes(x = num_obs, y = FID)) + geom_point()
```



```{r}
# log links ---------------------------------------------------------------

nonlin_formula_lnks <- bf(FID ~ exp(logM) * (1 - p*num_obs/(exp(logd) + num_obs)),
   logM ~ 1,
   p ~ 1,
   logd ~ 1,
   nl = TRUE,
   family = Gamma(link = "identity")
)

get_prior(nonlin_formula_lnks, data = fake_tamia)

nonlin_prior_lnks <- c(prior(normal(6,.5), class = "b", nlpar = "logM"),
  prior(beta(4,4), class = "b", nlpar = "p", lb = 0, ub = 1),
  prior(normal(1.5, .5), class = "b", nlpar = "logd"),
  prior(gamma(6.25, .25), class = "shape"))


nonlin_gamma_model_lnks <- brm(nonlin_formula_lnks,
                    data = fake_tamia,
                    prior = nonlin_prior_lnks,
                    backend = "cmdstanr",
                    file = "nonlin_model",
                    file_refit = "on_change")

summary(nonlin_gamma_model_lnks)

get_variables(nonlin_gamma_model_lnks)

nonlin_gamma_model_lnks |>
  spread_draws(b_logM_Intercept, b_p_Intercept, b_logd_Intercept) |>
  pivot_longer(starts_with("b")) |>
  ggplot(aes(x = value))+
  stat_halfeye()+
  facet_wrap(~name, scales = "free") +
  geom_vline(aes(xintercept = value),
             data = tribble(~name, ~value,
                            'b_logM_Intercept', log(M_fid),
                            "b_p_Intercept", prop_habituate,
                            "b_logd_Intercept", log(obs_demi)))

fake_tamia |>
  add_epred_draws(nonlin_gamma_model_lnks) |>
  ggplot(aes(x = num_obs, y = FID))+
  stat_lineribbon(aes(y = .epred)) +
  geom_point(data = fake_tamia, col = "darkgreen") +
  scale_fill_brewer(palette = "Oranges")
```

### try with a log link as well for p

We like this because if $p>0$, then  $e^p$ is greater than 1, which means that the chipmunk runs away farther. (sensibilisation)

```{r}
nonlin_form_all_logs <- bf(FID ~ exp(logM) * (1 - exp(logp)*num_obs/(exp(logd) + num_obs)),
   logM ~ 1,
   logp ~ 1,
   logd ~ 1,
   nl = TRUE,
   family = Gamma(link = "identity"))

get_prior(nonlin_form_all_logs, data = fake_tamia)

prior_all_logs <- c(
  prior(normal(6,.5), class = "b", nlpar = "logM"),
  prior(normal(0, .5), class = "b", nlpar = "logp"),
  prior(normal(1.5, .5), class = "b", nlpar = "logd"))

nonlin_gamma_model_lnks <- brm(nonlin_form_all_logs,
                    data = fake_tamia,
                    prior = prior_all_logs,
                    backend = "cmdstanr",
                    file = "all_logs_model",
                    file_refit = "on_change")

summary(nonlin_gamma_model_lnks)

fixef(nonlin_gamma_model_lnks)
log(known_M_fid)
log(known_prop_habituate)
log(known_obs_demi)
```

```{r eval=FALSE}
# shinystan::launch_shinystan(nonlin_gamma_model_lnks)
```



## Individual Tamia variation

add tamia IDs. We allow the tamia to have different values of $p$. these values have to be **between -1 and +1**. Negative values of p mean habituation ($-1<p<0$) that is, the FID goes down with repeat exposures. positive values $0<p<1$ mean that the FID goes up; the squirrel is becoming more sensitive.

```{r}

disp <- 50
nobs <- 15
n_tamia <- 40
known_M_fid <- 500
known_prop_habituate <- -.4
known_obs_demi <- 2

ecarts_p <- rnorm(n_tamia, mean = 0, sd = .6)
ecarts_p


# curve(plogis(x)*2-1, xlim = c(-4,4))
inv_scaled_known <- qlogis((known_prop_habituate + 1)/2)


many_fake_tamia <- expand_grid(tamia_id = 1:n_tamia, 
            num_obs = 1:nobs) |> 
  mutate(ecart_p = ecarts_p[tamia_id], 
          reponse_moy = known_M_fid * (1 + (plogis(inv_scaled_known + ecart_p)*2 - 1)*(num_obs - 1)/(known_obs_demi + (num_obs - 1)))
  )


many_fake_tamia |> 
  ggplot(aes(x = num_obs, y = reponse_moy, group = as.factor(tamia_id))) + geom_line()

fake_tamia <- tibble(num_obs = 1:nobs,
       reponse_moy = known_M_fid * (1 - known_prop_habituate*num_obs/(known_obs_demi + num_obs)),
       FID = rgamma(nobs, reponse_moy^2/disp^2, reponse_moy/disp^2))



fake_tamia
```


```{r}
nonlin_form_all_logs <- bf(FID ~ exp(logM) * (1 - exp(logp)*num_obs/(exp(logd) + num_obs)),
   logM ~ 1,
   logp ~ 1 + (1 | tamia_id),
   logd ~ 1 + (1 | tamia_id),
   nl = TRUE,
   family = Gamma(link = "identity"))

get_prior(nonlin_form_all_logs, data = fake_tamia)

prior_all_logs <- c(
  prior(normal(6,.5), class = "b", nlpar = "logM"),
  prior(normal(0, .5), class = "b", nlpar = "logp"),
  prior(normal(1.5, .5), class = "b", nlpar = "logd"))

nonlin_gamma_model_lnks <- brm(nonlin_form_all_logs,
                    data = fake_tamia,
                    prior = prior_all_logs,
                    backend = "cmdstanr",
                    file = "all_logs_model",
                    file_refit = "on_change")

```


Another way to write the model that might be less weird

```{r}

curve(exp(x)-4, xlim = c(-6,2))
abline(h = -4)

curve(200 + (-200)*(x - 1)/(.3 + x - 1), xlim = c(1, 15), ylim = c(0,300))
abline(h= 0)


# slightly increasing; log200 is 5.2
curve(200 + (exp(5.4) - 200)*(x - 1)/(.3 + x - 1), xlim = c(1, 15), ylim = c(0,300))

fid_fn <- function(x, fo, g, b) {
  fo + (exp(g) - fo)*(x - 1)/(.3 + x - 1)
# fo + (exp(g) - fo)*(x - 1)/( b + x - 1)
}
curve(fid_fn(x, 200, 5.4, .3), xlim = c(1, 15), ylim = c(0,280))

```



## treatment effects
